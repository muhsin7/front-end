<!DOCTYPE html>
<html>
  <head>
    <!-- /////////////////////////////////////////////////////// -->
    <link rel="stylesheet" href="../css/icons.css">
    <link rel="stylesheet" href="../css/materialize.css">
    <link rel="stylesheet" href="../css/materialize.css">
    <link rel="stylesheet" href="../css/nord-colours.css">
    <link rel="stylesheet" href="../css/styles.css">
    <!-- /////////////////////////////////////////////////////// -->

  </head>
  <body>

    <nav class="nord-darkblue" role="navigation">
      <ul id="profileDropdown" class="dropdown-content">
        <li><a href="/profile/" class="modal-trigger">Profile</a></li>
        <li><a href="/auth/logout" class="modal-trigger">Log out</a></li>
      </ul>
      <div class="nav-wrapper container">
        <a id="logo-container" href="/home/" class="brand-logo"><img src="../images/cisco.png" height="50px" width="auto" style="padding-top:5px;" /></a>
        <ul class="right hide-on-med-and-down">
          <li><a href="/home/">Home</a></li>
          <li><a href="/assignments/">Assignments</a></li>
          <li><a class="modal-trigger nord-orange" href="#notificationsModal"><i class="material-icons">notifications</i></a></li>
          <li><a class="dropdown-trigger" href="#!" data-target="profileDropdown"><i class="material-icons">person arrow_drop_down</i></a></li>
        </ul>

        <ul id="nav-mobile" class="sidenav">
          <li><a href="/home/">Home</a></li>
          <li><a href="/assignments/">Assignments</a></li>
          <li><a href="/profile/" class="modal-trigger">Profile</a></li>
          <li><a href="/auth/logout" class="modal-trigger">Log out</a></li>
        </ul>
        <a href="#" data-target="nav-mobile" class="sidenav-trigger"><i class="material-icons">menu</i></a>
      </div>
    </nav>
    <br /><br />

    <div class="modal" id="notificationsModal">
      <div class="modal-content">
        <center>
          <i class='material-icons nord-orange-text medium'>notifications</i>
        </center>
        <session-error>
          <ul class="collection notification-collection">
          <a href="#">
            <li class="collection-item modal-notification post-notif">
              <img src="../images/default.jpg" class="modal-notif-pfp"/>
              <div>
                <div class="truncate nord-purple-text notif-content">
                  <b>Name</b> posted a <b>thing</b> in <b>class</b>
                </div>
                <div class="truncate">
                  Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                </div>
              </div>
            </li>
          </a>
          <a href="#">
            <li class="collection-item modal-notification assignment-notif">
              <img src="../images/default.jpg" class="modal-notif-pfp"/>
              <div>
                <div class="truncate nord-purple-text notif-content">
                  <b>Teacher</b> posted an <b>assignment</b> in <b>class</b>
                </div>
                <div class="truncate">
                  Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                </div>
              </div>
            </li>
          </a>
          <a href="#">
            <li class="collection-item modal-notification comment-notif">
              <img src="../images/default.jpg" class="modal-notif-pfp"/>
              <div>
                <div class="truncate nord-purple-text notif-content">
                  <b>Name</b> replied to your comment in <b>class</b>
                </div>
                <div class="truncate">
                  Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                </div>
              </div>
            </li>
          </a>
        </ul>
        </session-error>
        <ul class="collection notification-collection" id="notificationsContainer">

        </ul>
      </div>
    </div>


    <div>
      <ul class="dropdown-content" id="post-dropdown">
        <li class="modal-trigger" href="#editModal" id="editPostButton"><a>Edit Post</a></li>
        <li class="warn modal-trigger" href="#deletePostModal" id="deletePostButton"><a>Delete Post</a></li>
      </ul>

      <div class="modal" id="editModal">
        <div class="modal-content">
          <div>
            <h5>Edit post</h5>
            <input type="hidden" name="postID" id="edit-postID" value="${postID}">
            <div class="input-field">
              <textarea class="materialize-textarea" id="editPostContent">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</textarea>
            </div>
            <div class="row">
              <ul class="collection files" id="edit-old-file-container">
                <session-error>
                  <li class="collection-item" class="file"><div><a href="#">file_name.mp3</a><a href="#" class="secondary-content"><i class="white material-icons nord-red remove_file tiny">close</i></a></div></li>
                  <li class="collection-item" class="file"><div><a href="#">file_name.mp3</a><a href="#" class="secondary-content"><i class="white material-icons nord-red remove_file tiny">close</i></a></div></li>
                  <li class="collection-item" class="file"><div><a href="#">file_name.mp3</a><a href="#" class="secondary-content"><i class="white material-icons nord-red remove_file tiny">close</i></a></div></li>
                </session-error>
              </ul>
            </div>
            <div class="row">
              <a class="btn nord-red">
                <span class="valign-wrapper" id="edit-attach-file-button"><i class="material-icons">attach_file</i>Attach (more) files</span>
                <input type="file" multiple id="edit-attach-file" class="hidden">
              </a>
            </div>
            <div class="row">
              <ul class="collection files" id="edit-new-file-container">

              </ul>
            </div>
            <button type="submit" name="button" class="btn-large nord-darkblue" id="edit-submit">Post</button>
            <div class="btn-large nord-red modal-close">Cancel</div>
          </div>
        </div>
      </div>

      <div class="modal" id="deletePostModal">
        <div class="modal-content">
          <center>
            <h5>Are you sure you want to delete this post?</h5>
            <br />
            <div class="form" action="/api/post/delete" method="POST" on-error-prompt-selector=".red" on-error="console.log(response)" on-success-redirect="/home">
              <input type="text" name="postID" value="${postID}" class="hidden">
              <span class="red"></span><br>
              <button class="btn-large nord-red" type="submit">Delete post</button>
              <div class="btn-large nord-darkblue modal-close">Cancel</div>
            </div>
          </center>
        </div>
      </div>

    </div>



    <div class="container col offset-s1 s8">
      <div class="row" id="postContainer">
        <div class="post hoverable" id="samplePost">
          <div class="post-header">
            <img class="post-pfp" src="../images/default.jpg" />
          </div>
          <div class="poster">${user}<a href="#" class="dropdown-trigger hidden show-if-owner" data-target="post-dropdown"><i class="material-icons post-options">more_horiz</i></a></div>
          <a href="/class/${classID}" class="post-class">${class}</a>
          <span class="date-text">${dateCreated}</span>
          <div class="more" id="contentOfPost">${content}</div>
          <div id="attachment-container">
            <session-error>
              <a href="#"><i class="tiny material-icons">attach_file</i> attached_file.png</a>
            </session-error>
          </div>
          <hr />
          <h6><b>Comments</b></h6>
          <div class="form comment-form" method='POST' action="/api/post/comment/create" on-success-reload="true" on-error="console.log(response)">

          <input name="postID" type="text" value="${postID}" class="hidden comment-input"/>
            <input name="content" type="text" class="comment-input" placeholder="Comment here..."/>
            <button name="comment-btn" type="submit" name="button" class="right-align btn nord-red">Comment</button>
            <br /><br />
          </div>
          <div class="comments">
            <div id="commentContainer">

            </div>
            <div class="hidden" id="sampleContainer">
              <div class="comment">
                <div class="comment-marker nord-darkblue"></div>
                <img class="comment-pfp" src="../images/default.jpg"/>
                <div class="comment-poster">Kabir</div><span class="date-text">3:45PM, Wednesday, October 15th, 2019</span>
                <div class="comment-text more">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</div>
              </div>
              <div class="comment">
                <div class="comment-marker nord-darkblue"></div>
                <img class="comment-pfp" src="../images/default.jpg"/>
                <div class="comment-poster">Kabir</div><span class="date-text">3:45PM, Wednesday, October 15th, 2019</span>
                <div class="comment-text more">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</div>
              </div>
              <div class="comment">
                <div class="comment-marker nord-darkblue"></div>
                <img class="comment-pfp" src="../images/default.jpg"/>
                <div class="comment-poster">Kabir</div><span class="date-text">3:45PM, Wednesday, October 15th, 2019</span>
                <div class="comment-text more">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</div>
              </div>
              <div class="load-more-comments">
                <a href="/post/">[Load more comments...]</a>
              </div>
            </div>
            </div>
        </div>
      </div>
    </div>


    <!-- /////////////////////////////////////////////////////// -->
    <script type="text/javascript" src="../js/angular.min.js"></script>
    <script type="text/javascript" src="../js/jquery.js"></script>
    <script type="text/javascript" src="../js/materialize.js"></script>
    <script type="text/javascript" src="../js/materialize.min.js"></script>
    <script type="text/javascript" src="../js/initializing.js"></script>
    <script type="text/javascript" src="../js/script.js"></script>
    <script type="text/javascript" src="../js/events.js"></script>
    <backend-data key="classID">${classID}</backend-data>
    <!-- /////////////////////////////////////////////////////// -->
    <script type="text/javascript">
      $.initSession();
      // $(window).on("sessionLoaded",(event,error,response) => {
      //   l(response)
      // })
      $(window).on("sessionLoaded",(event,error,sessionData) => {
        $.ajax({
        url:"/api/post/list",
        type:'POST',
        data:{classID:$.getDataValue("classID")},
        success:function(data){
          data = data.filter((e) => {
            let id = splitUrl().lastElem();
            id = id.substring(0,((id.indexOf("#")>0)?id.indexOf("#"):id.length))
            return e.id==id
          })[0]
          if(data.poster == sessionData.id) {
            $('.delete-if-not-owner').remove()
            $('.show-if-owner').removeClass('hidden')
          }
          let commentsList = data.comments;
          let comments = ""
          for (let comment of commentsList) {
            let {id,dateCreated,commenter,commenterName,content} = comment;
            let contentContent= content;
            let isOwnerOfComment = (commenter == sessionData.id)
            let dateCommented = new Date(dateCreated).getSemiSimpleTime()
            comments+=`<div class="comment">
            <div class="comment-marker nord-darkblue"></div>
            <img class="comment-pfp" src="../images/default.jpg"/>
            <div class="comment-poster">${commenterName}</div><span class="date-text">${dateCommented}</span>
            ${(isOwnerOfComment)?
              `
              <span class="date-text small-side-margin edit-comment pointer-cursor" post-id="${id}"><a>Edit  </a></span>
              <span class="date-text modal-trigger small-side-margin delete-comment pointer-cursor" comment-id="${id}" href="#deleteCommentModal"><a>Delete</a></span>
              `:""
            }
            <textarea class="materialize-textarea comment-readonly" readonly>${contentContent}</textarea>
            </div>`
          }
          // l(comments)
          $('#commentContainer').html(comments)
        },error:function(err){
          console.error(err)
        }
      })
      })
      $("#editPostButton").on('click',() => {
        $('#editPostContent').val($('#contentOfPost').text())
      })
      $("#deletePostButton").on('click',() => {
      })
      $('#editForm').on('success',() => {
        $('#contentOfPost').text($('#editPostContent').val());
        $('#editCancel').click()
      })


        $.ajax({
          url:"/api/post/get/${postID}",
          type:"GET",
          success:function(response){
            // l(response)
            let {attachments} = response;
            $('#edit-old-file-container').html('')
            for(let attachment of attachments){
              $('#attachment-container').append(
                $(
                  `
                  <a href="#"><i class="tiny material-icons">attach_file</i>${attachment.originalName}</a><br />
                  `
                )
              )
              $('#edit-old-file-container').append(
                $(
                  `<li class="collection-item" class="file"><div><a href="#">${attachment.originalName}</a><a class="secondary-content"><i  file-name="${attachment.originalName}" file-id="${attachment.fileName}" class="white edit-remove-file material-icons nord-red remove_file tiny">close</i></a></div></li>`
                )
              )
            }
            $('#edit-old-file-container .edit-remove-file').on('click',function(){
              let elem = $(this);
              let originalName = elem.attr("file-name");
              let fileName = elem.attr("file-id");
              $("#edit-attach-file")[0].removedFiles = $("#edit-attach-file")[0].removedFiles || [];
              $("#edit-attach-file")[0].removedFiles.push({fileName,originalName})
              elem.parents(".collection-item").eq(0).remove()
              // l($("#edit-attach-file")[0].removedFiles)
            })

          }
        })
      $('#edit-attach-file-button').on('click',() => {
        $('#edit-attach-file').click()
      })
      $('#edit-attach-file').on('change',() => {
        let elem = $('#edit-attach-file')[0];
        elem.fileList = elem.fileList || [];
        for(let file of elem.files){
          elem.fileList.push(file);
          $('#edit-new-file-container').append(
            $(
              `<li class="collection-item" class="file"><div><a href="#">${file.name}</a><a class="secondary-content"><i  file-name="${file.name}" class="white edit-remove-file material-icons nord-red remove_file tiny">close</i></a></div></li>`
            )
          )
        }
        $('#edit-new-file-container .edit-remove-file').off('click')
        $('#edit-new-file-container .edit-remove-file').on('click',function() {
          let button = $(this)
          for (let i = 0; i < elem.fileList.length; i++) {
            let file = elem.fileList[i];
            if(file.name == button.attr("file-name")) elem.fileList.splice(i,1)
          }
          button.parents('.collection-item').eq(0).remove()
          l(elem.fileList)
        })
      })
      $('#edit-submit').on('click',() => {
        let postID = $('#edit-postID').val();
        let content = $('#editPostContent').val();
        let fileUpload = $('#edit-attach-file')[0]
        fileUpload.removedFiles = fileUpload.removedFiles || []
        fileUpload.fileList = fileUpload.fileList || []
        let formData = new FormData();
        formData.append("postID",postID);
        formData.append("content",content);
        for(let removedFile of fileUpload.removedFiles){
          formData.append('removedFiles',JSON.stringify(removedFile))
        }
        for(let addedFile of fileUpload.fileList){
          formData.append('additionalFiles',new Blob([addedFile]),addedFile.name)
        }
        $.ajax({
            url:"/api/post/edit?json=true&postFiles=true",
            type:"POST",
            data:formData,
            contentType:false,
            processData:false,
            cache:false,
            success:function(data){
              window.location.reload(true)
              console.log(data)
            },error:function(data){
              console.error(data)
            }
          })
      })
    </script>
  </body>
</html>
