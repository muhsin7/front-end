<!-- ~SessionRequired~ -->
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
    <title>Profile</title>

    <!-- /////////////////////////////////////////////////////// -->
    <link rel="stylesheet" href="../css/icons.css">
    <link rel="stylesheet" href="../css/materialize.css">
    <link rel="stylesheet" href="../css/materialize.css">
    <link rel="stylesheet" href="../css/nord-colours.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style media="screen">
      .activeTabButton {
        background-color:rgba(0,0,0,0);
        color:#722C8A
      }
      .tab {
        border:2px #722C8A solid
      }
      .tab:hover {
        border:2px #722C8A solid
      }
    </style>
    <!-- /////////////////////////////////////////////////////// -->
    <script type="text/javascript">
    </script>
</head>
<div class="modal" id="deleteCommentModal">
  <div class="modal-content">
    <center>
      <div class="form" method="POST" action="/api/post/comment/delete" on-success-reload="true" on-error="console.error(response)">
        <input type="text" class='hidden' name="commentID" value="" id="deleteCommentId">
        <h5>Are you sure you want to delete this comment?</h5>
        <br />
        <button class="btn-large nord-red" type="submit">Delete comment</button>
        <div class="btn-large nord-darkblue modal-close">Cancel</div>
      </div>
    </center>
  </div>
</div>
  <body>
    <nav class="nord-darkblue" role="navigation">
      <ul id="profileDropdown" class="dropdown-content">
        <li class="active"><a href="profile.html" class="modal-trigger">Profile</a></li>
        <li><a href="/auth/logout" class="modal-trigger">Log out</a></li>
      </ul>
      <div class="nav-wrapper container">
        <a id="logo-container" href="/home/" class="brand-logo"><img src="../images/cisco.png" height="50px" width="auto" style="padding-top:5px;" /></a>
        <ul class="right hide-on-med-and-down">
          <li><a href="/home/">Home</a></li>
          <li><a href="assignments.html">Assignments</a></li>
          <li><a class="dropdown-trigger" href="#!" data-target="profileDropdown"><i class="material-icons">person arrow_drop_down</i></a></li>
        </ul>

        <ul id="nav-mobile" class="sidenav">
          <li><a href="/home/">Home</a></li>
          <li><a href="assignments.html">Assignments</a></li>
          <li class="active"><a href="profile.html" class="modal-trigger">Profile</a></li>
          <li><a href="logout.html" class="modal-trigger">Log out</a></li>
        </ul>
        <a href="#" data-target="nav-mobile" class="sidenav-trigger"><i class="material-icons">menu</i></a>
      </div>
    </nav>

  <div class="container profile-header">
              <div class="row">
                  <div>
                    <img src="/api/users/${userID}/image" class="profile-pfp">
                  </div>
                  <div class="profile_info">
                    <h1>${username}</h1>
                  </div>
              </div>
  </div>

	<!--yeah all that man all that-->
	<div>
		<!-- <div class = "row">
			<u><h3 class = "col offset-s1">User Details</h3></u>
		</div> -->
    <div class = "row">
  		<div class = "col s6 offset-s3 center-align">
  			<div id = "tab_button" class = "col s5 tab" onclick="activateTab('profile-posts','main')">Posts</div>
        <div id = "tab_button" class = "col s5 tab" onclick="activateTab('profile-details','main')">User Details</div>
        <!-- <div id = "tab_button" class = "col s3 tab" style = "text-align: center; border-radius: 0px; margin: 1px;" onclick="activateTab('')">Extra tab in case</div> -->
  		</div>
    </div>
	</div>

	<div class = "container" tab-container-id="main">
		<div id = "profile-posts" tab-id="profile-posts" style = "" class="tab-panel">
      <div class="container col offset-s1 s8">
        <div class="row" id="postContainer">
          <div class="post hoverable hidden" id="samplePost">
            <div class="post-header">
              <img class="post-pfp" src="../images/default.jpg" />
            </div>
            <div class="poster">Kabir De Sarkar<a href="#" class="dropdown-trigger" data-target="post-dropdown"><i class="material-icons post-options">more_horiz</i></a></div>
            <a href="#" class="post-class">IBDP1 Chemistry</a>
            <span class="date-text">3:45PM, Wednesday, October 15th, 2019</span>
            <div class="more">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</div>
            <a href="#"><i class="tiny material-icons">attach_file</i> attached_file.png</a>
            <hr />
            <h6><b>Comments</b></h6>
            <div class="form">
              <input name="comment" type="text" class="comment-input"/>
              <button name="comment-btn" type="submit" name="button" class="right-align btn nord-red">Comment</button>
              <br /><br />
            </div>
            <div class="comments">
              <div class="comment">
                <div class="comment-marker nord-darkblue"></div>
                <img class="comment-pfp" src="../images/default.jpg"/>
                <div class="comment-poster">Kabir</div><span class="date-text">3:45PM, Wednesday, October 15th, 2019</span>
                <div class="comment-text more">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</div>
              </div>
              <div class="comment">
                <div class="comment-marker nord-darkblue"></div>
                <img class="comment-pfp" src="../images/default.jpg"/>
                <div class="comment-poster">Kabir</div><span class="date-text">3:45PM, Wednesday, October 15th, 2019</span>
                <div class="comment-text more">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</div>
              </div>
              <div class="comment">
                <div class="comment-marker nord-darkblue"></div>
                <img class="comment-pfp" src="../images/default.jpg"/>
                <div class="comment-poster">Kabir</div><span class="date-text">3:45PM, Wednesday, October 15th, 2019</span>
                <div class="comment-text more">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</div>
              </div>
            </div>
            <div class="load-more-comments">
              <a href="/post/">[Load more comments...]</a>
            </div>
          </div>
        </div>
      </div>
		</div>

    <div class="modal" id="usernameEditModal">
      <div class="modal-content">
        <div class="form" method="POST" action="/auth/change/username" on-error-prompt-selector=".red-prompt" on-success-reload="true">
          <center>
            <h2>Edit your username</h2>
            <h4><input type="text" name="username" placeholder="Enter new username" value="${username}"/></h4>
            <h4><input type="password" name="password" placeholder="Enter password to confirm" value=""/></h4>
            <h6 class="red-prompt"></h6>
            <div class="btn-large nord-darkblue modal-close">Cancel</div>
            <button type="submit" class="btn-large nord-red">Submit</button>
          </center>
        </div>
      </div>
    </div>

    <div id = "profile-details"  class="tab-panel activeTab" tab-id="profile-details">
			<div class="container col offset-s1 s8">
        <div><h4><span><b>Username: </b></span><span>${username}</span></h4></div>
        <div><h4><span><b>Posts: </b></span><span id="numberOfPosts"></span></h4></div>
        <div><h4><span><b>Comments: </b></span><span id="numberOfComments"></span></h4></div>
        <!-- <hr>
        <span><b>First Name: </b><span>{FIRST NAME}</span></span>
        <span><b>Last Name: </b><span>{LAST NAME}</span></span>
        <hr>
        <span><b>Posts created: </b><span>{Number of posts}</span></span>
        <span><b>Comments:</b><span>{Number of comments}</span></span>
		  </div>

      <div id = "edit-details" style = "display: none" class = "container col offset-s1 s8">
        <form>
          <span style = "margin-right: 0px;"><b>Username: </b></span><span>{USERNAME}</span>
          <hr>
          <span><b>First Name: </b><input value = "{FIRST NAME}"></span>
          <span><b>Last Name: </b><input value = "{LAST NAME}"></span>
          <hr>
          <span><b>Posts created: </b><span>{Number of posts}</span></span>
          <span><b>Comments:</b><span>{Number of comments}</span></span>
          <button type = "submit" href = "public\private\profile.html">Save</button>
      </form>
      </div>

		</div>

    <div id = "profile-extras" style = "display: none;">
    </div>

	</div>

  <div class = "assignment-subject" style = "border: solid; max-width: 5%;">
    <a onclick = "
    document.getElementById('edit-details').style.display = 'block';
    document.getElementById('set-details').style.display = 'none';
    ">Edit</a>
  </div>

    /////////////////////////////////////////////////////// -->
    <script type="text/javascript" src="/js/angular.min.js"></script>
    <script type="text/javascript" src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/materialize.js"></script>
    <script type="text/javascript" src="/js/materialize.min.js"></script>
    <script type="text/javascript" src="/js/initializing.js"></script>
    <script type="text/javascript" src="/js/script.js"></script>
    <script type="text/javascript" src="/js/events.js"></script>
    <!-- /////////////////////////////////////////////////////// -->
    <script>
    $.initSession()
    $(window).on('sessionLoaded',(event,error,sessionData) => {
      $.ajax({
        url:`/api/users/${userID}/stats`,
        type:'GET',
        success:function(data){
          // console.log(data)
          $('#numberOfPosts').html(data.posts)
          $('#numberOfComments').html(data.comments)
        }, error:function(err){
          console.log(err.responseText)
        }
      })
      // $.ajax({
      //   url:"/api/users/"+sessionData.id+"/getAllPosts",
      //   type:"GET",
      //   success:function(data){
      //     console.log(data);
      //   }, error:function(data){
      //     console.error(data)
      //   }
      // })
      $.ajax({
      url:"/api/users/${userID}/getAllPosts",
      type:"GET",
      success:function(response){
        // console.log(response)
        let postContainer = $('#postContainer');
        $('#samplePost').addClass('hidden')
        // for(let post of response){
        //   let {classID,className,content,title,posterName,dateCreated} = post;
        //   dateCreated = new Date(dateCreated).getSemiSimpleTime();
        //
        //   let elem = $(`<div class="post">
        //     <a href="/class/${classID}" class="assignment-subject bold-text blue-text">${className}</a>
        //     <h5>${title}</h5>
        //     <h7>${posterName}</h7><br>
        //     <span class="grey-text small-text">${dateCreated}</span>
        //     <h6>${content}</h6>
        //   </div>`)
        //   postContainer.append(elem)
        // }
        // response = response.reverse();
        // let dropDownHTML = ""
        response = response.reverse()
        for(let post of response){
          // console.log(post)
          let {classID,className,content,title,posterName,dateCreated,poster} = post;
          let postID = post.id;
          dateCreated = new Date(dateCreated).getSemiSimpleTime();
          let ifTeacherAccountAddElementHere = ''
          comments = "";
          let isOwnerOfPost = (poster==sessionData.id)
          // let dropDownTextEditable = (isOwnerOfPost) ? `<li class="modal-trigger edit-post-modal-trigger" href="#editModal" post-id="${postID}"><a>Edit Post</a></li>
          // <li class="warn modal-trigger delete-post-modal-trigger" href="#deletePostModal" post-id="${postID}"><a>Delete Post</a></li>` : ""
          // dropDownHTML += `<ul class="dropdown-content" id="post-dropdown-${postID}">
          //   <li><a href="/post/${postID}">Go to post</a></li>
          //   ${dropDownTextEditable}
          // </ul>`
          if(post.comments.length > 0){
            let amount = (post.comments.length>3)? 3:post.comments.length
            for(let i=0;i<amount;i++){
              let comment = post.comments[i]
              let {id,dateCreated,commenter,commenterName,content} = comment;
              let isOwnerOfComment = (commenter==sessionData.id);
              let dateCommented = new Date(dateCreated).getSemiSimpleTime()
              comments+=`<div class="comment">
              <div class="comment-marker nord-darkblue"></div>
              <img class="comment-pfp" src="/api/users/${commenter}/image"/>
              <div class="comment-poster">${commenterName}</div><span class="date-text">${dateCommented}
              ${(isOwnerOfComment)?
                `
                <span class="date-text small-side-margin edit-comment pointer-cursor" post-id="${id}"><a>Edit  </a></span>
                <span class="date-text modal-trigger small-side-margin delete-comment pointer-cursor" comment-id="${id}" href="#deleteCommentModal"><a>Delete</a></span>
                `:""
              }
              </span>
              <!-- <div class="comment-text more">${content}</div> -->
              ${(isOwnerOfComment)?
                `
                <div class="form comment-edit-form" action="/api/post/comment/edit" method="POST">
                  <input type="hidden" name="commentID" value="${id}">
                  <textarea class="materialize-textarea comment-readonly" readonly name="content">${content}</textarea>
                  <div class="hidden">
                  <button class="btn nord-red" type="submit">SAVE CHANGES</button>
                  <button class="btn nord-blue comment-edit-cancel-button">CANCEL</button>
                  </div>
                </div>
                `
                :
                `
                <textarea class="materialize-textarea comment-readonly" readonly>${content}</textarea>
                `
              }
              </div>`
            }
          }
          let attachmentContent = ""
          // l(post.attachments)
          post.attachments = post.attachments || []
          for(let attachment of post.attachments){
            attachmentContent+=
            `<a href="/class/${classID}/attachment/${attachment.fileName}"><i class="tiny material-icons">attach_file</i> ${attachment.originalName}</a><br>`
          }
          let loadMoreContainer = (post.comments.length > 3) ? `<div class="load-more-comments">
            <a href="/post/${postID}">[Load more comments...]</a>
          </div>` : ''
          let elem = $(`<div class="post hoverable">
            <div class="post-header">
              <img class="post-pfp" src="/api/users/${poster}/image" />
            </div>
            <!--
            <a post-id="${postID}" owner="${isOwnerOfPost}" class="dropdown-trigger" data-target="post-dropdown-${postID}"><i class="material-icons post-options">more_horiz</i></a>
            -->
            <div class="poster">${username}</div>
            ${ifTeacherAccountAddElementHere}
            <a href="/class/${classID}" class="post-class">${className}</a>
            <span class="date-text">${dateCreated}</span>
            <span class="date-text small-side-margin pointer-cursor"><a href="/post/${postID}">Go to post  </a></span>
            ${(isOwnerOfPost)?
            `
            <span class="date-text modal-trigger pointer small-side-margin edit-post pointer-cursor" post-id="${postID}" href="#editModal"><a>Edit  </a></span>
            <span class="date-text pointer modal-trigger small-side-margin delete-post pointer-cursor" post-id="${postID}" href="#deletePostModal"><a>Delete</a></span>

            `:""
            }
            <div class="more content-of-post">${content}</div>
            ${attachmentContent}
            <hr />
            <h6><b>Comments</b></h6>
            <div class="form comment-form" method='POST' action="/api/post/comment/create?json=true"  on-error="console.log(response)">

              <input name="postID" type="text" value="${postID}" class="hidden comment-input"/>
              <input name="content" type="text" class="comment-input" placeholder="Comment here..."/><br>
              <button name="comment-btn" type="submit" name="button" class="right-align btn nord-red">Comment</button>
              <br /><br />
            </div>
            <div class="comments">
              ${comments}
            </div>
            ${loadMoreContainer}
          </div>`)
          postContainer.append(elem)
        }
        // console.log(postContainer)
        if(response.length == 0){
          postContainer.append($(`<center><h6 class="grey-text">No posts to be loaded</h6></center>`))
        }
        try {
          $('.dropdown-trigger').dropdown();
        } catch (e) {
          console.warn("Lol, dropdowns do not work sir")
        }
        $('.edit-comment').on('click',function(){
          let elem = $(this);
          let form = elem.parents(".comment").eq(0).find(".comment-edit-form");
          // l(form)
          let textarea = form.find('[name=content]')
          let hiddenDiv = form.find("div.hidden")
          hiddenDiv.removeClass('hidden');
          textarea.removeAttr("readonly");
          textarea.attr("initial-value",textarea.val())
          elem.addClass('hidden');
          form.find('.comment-edit-cancel-button').eq(0).off("click")
          form.find('.comment-edit-cancel-button').eq(0).on("click",function(){
            textarea.val(textarea.attr("initial-value"));
            hiddenDiv.addClass('hidden');
            elem.removeClass('hidden')
          })
          form.on('success',function(){
            hiddenDiv.addClass("hidden");
            textarea.attr("readonly","")
            textarea.attr("initial-value",textarea.val());
            elem.removeClass('hidden')
          })
          form.on('error',function(event,err){
            l(err)
          })
        })
        $('.delete-comment').on("click",function(){
          let elem = $(this);
          $('#deleteCommentId').attr("value",elem.attr('comment-id'))
        })
        // $('.post-dropdown-button').on('click',function() {
        //   let elem = $(this);
        //   $('#dropdownPostLink a').attr('href',`/post/${elem.attr("post-id")}`)
        //   if(elem.attr("owner") == 'true') {
        //     // $('#hiddenDropdown').removeClass('hidden')
        //     $('#editPostButton').removeClass('hidden')
        //     $('#deletePostButton').removeClass('hidden')
        //   }
        //   else {
        //     $('#editPostButton').addClass('hidden')
        //     $('#deletePostButton').addClass('hidden')
        //     // $('#hiddenDropdown').addClass('hidden')
        //   }
        // })
        initForms()
        $('.comment-form').on("success", function(event,response){
          let elem = $(this);
          let commentID = response.comment.id
          let commentInput = elem.children(`.comment-input`).eq(1);
          let commentValue = commentInput.val()
          let user = sessionStorage.getItem("user")
          // l(elem.parent().children(".comments").eq(0));
          let commentElem = elem.parent().children('.comments').eq(0);
          let comment = $(`
            <div class="comment">
              <div class="comment-marker nord-darkblue"></div>
              <img class="comment-pfp" src="../images/default.jpg"/>
              <div class="comment-poster">${user}</div><span class="date-text small-side-margin">${new Date().getSemiSimpleTime()}</span>
              <span class="date-text small-side-margin edit-comment pointer-cursor"><a>Edit</a></span>
              <span class="date-text modal-trigger small-side-margin delete-comment pointer-cursor" comment-id="${commentID}" href="#deleteCommentModal"><a>Delete</a></span>
              <div class="form comment-edit-form" action="/api/post/comment/edit" method="POST">
                <input type="hidden" name="commentID" value="${commentID}">
                <textarea class="materialize-textarea comment-readonly" readonly name="content">${commentValue}</textarea>
                <div class="hidden">
                <button class="btn nord-red" type="submit">SAVE CHANGES</button>
                <button class="btn nord-blue comment-edit-cancel-button">CANCEL</button>
                </div>
              </div>
            </div>
          `)
          commentElem.append(comment);
          commentInput.val("")
          $('.delete-comment').off('click')
          $('.edit-comment').off('click');
          $('.edit-comment').on('click',function(){
            let elem = $(this);
            let form = elem.parents(".comment").eq(0).find(".comment-edit-form");
            // l(form)
            let textarea = form.find('[name=content]')
            let hiddenDiv = form.find("div.hidden")
            hiddenDiv.removeClass('hidden');
            textarea.removeAttr("readonly");
            textarea.attr("initial-value",textarea.val())
            elem.addClass('hidden');
            form.find('.comment-edit-cancel-button').eq(0).off("click")
            form.find('.comment-edit-cancel-button').eq(0).on("click",function(){
              textarea.val(textarea.attr("initial-value"));
              hiddenDiv.addClass('hidden');
              elem.removeClass('hidden')
            })
            form.on('success',function(){
              hiddenDiv.addClass("hidden");
              textarea.attr("readonly","")
              textarea.attr("initial-value",textarea.val());
              elem.removeClass('hidden')
            })
            form.on('error',function(event,err){
              l(err)
            })
          })
          $('.delete-comment').on("click",function(){
            let elem = $(this);
            $('#deleteCommentId').attr("value",elem.attr('comment-id'))
          })
        })

      }, error:function(error){
        $('#samplePost').removeClass("hidden")
        console.error(error.responseText)
      }
    });

    })

    // For EDITING


    // for posting
    //////DROPDOWN//////
    // $('.dropdown-trigger').dropdown();
    ///////////////////
     window.activateTabButton = function(elem){
      $(elem).parent().children(".activeTabButton").removeClass(".activeTabButton")
      $(elem).addClass(".activeTabButton")
    }
    </script>
  </body>



</html>
